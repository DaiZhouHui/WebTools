<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV IP与端口提取工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.5;
            padding: 12px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.07);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            min-height: 520px;
        }
        
        .left-panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border-right: 1px solid #eaeaea;
            background-color: #fafbfc;
        }
        
        .right-panel {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            background-color: #ffffff;
        }
        
        .panel-title {
            font-size: 17px;
            color: #2c3e50;
            margin-bottom: 16px;
            padding-bottom: 6px;
            border-bottom: 2px solid #4b6cb7;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .panel-title i {
            color: #4b6cb7;
        }
        
        .upload-area {
            border: 2px dashed #b8c2cc;
            border-radius: 7px;
            padding: 24px 12px;
            text-align: center;
            margin-bottom: 18px;
            transition: all 0.3s;
            background-color: white;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #4b6cb7;
            background-color: #f8f9ff;
        }
        
        .upload-area i {
            font-size: 36px;
            color: #7e8c9e;
            margin-bottom: 10px;
        }
        
        .upload-area h3 {
            margin-bottom: 6px;
            color: #4a5568;
            font-size: 15px;
        }
        
        .upload-area p {
            color: #718096;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #4b6cb7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #3a5795;
        }
        
        .btn-upload {
            background-color: #4b6cb7;
        }
        
        .btn-extract {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            margin-top: 0;
            margin-bottom: 20px;
            background-color: #2d3748;
        }
        
        .btn-extract:hover {
            background-color: #1a202c;
        }
        
        .btn-download {
            background-color: #38a169;
            margin-right: 6px;
        }
        
        .btn-download:hover {
            background-color: #2f855a;
        }
        
        .btn-copy {
            background-color: #3182ce;
        }
        
        .btn-copy:hover {
            background-color: #2c5282;
        }
        
        .config-section {
            margin-top: 20px;
        }
        
        .config-item {
            margin-bottom: 15px;
        }
        
        .config-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
            font-size: 13px;
        }
        
        .config-item input, .config-item select {
            width: 100%;
            padding: 9px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.3s;
        }
        
        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #4b6cb7;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.1);
        }
        
        .preview-area {
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 12px;
            background-color: #f8fafc;
            margin-top: 15px;
            height: 360px;
            overflow-y: auto;
        }
        
        .preview-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            line-height: 1.4;
            color: #2d3748;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            margin-top: 10px;
        }
        
        .file-info {
            background-color: #edf2f7;
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        
        .file-info i {
            color: #4b6cb7;
        }
        
        .result-stats {
            color: #718096;
            font-size: 12px;
            margin-top: 6px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 12px;
            margin-top: 0;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 1px solid #eaeaea;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-file-csv"></i> CSV IP与端口提取工具</h1>
            <p class="subtitle">上传CSV文件，自动提取IP和端口信息，支持自定义格式导出</p>
        </header>
        
        <div class="main-content">
            <!-- 左侧面板：上传和配置 -->
            <div class="left-panel">
                <div class="panel-title">
                    <i class="fas fa-upload"></i> 文件上传与配置
                </div>
                
                <div class="upload-area" id="dropArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>拖放CSV文件到此处</h3>
                    <p>或点击选择文件上传</p>
                    <input type="file" id="fileInput" accept=".csv" hidden>
                    <button class="btn btn-upload" id="selectFileBtn">选择CSV文件</button>
                    <p class="result-stats" id="fileInfo">未选择文件</p>
                </div>
                
                <button class="btn btn-extract" id="extractBtn">
                    <i class="fas fa-cogs"></i> 提取IP和端口信息
                </button>
                
                <div class="config-section">
                    <div class="config-item">
                        <label for="connector">
                            <i class="fas fa-link"></i> IP与端口连接符
                        </label>
                        <select id="connector">
                            <option value=":">冒号 : (ip:port)</option>
                            <option value="|">竖线 | (ip|port)</option>
                            <option value="-">连字符 - (ip-port)</option>
                            <option value="_">下划线 _ (ip_port)</option>
                            <option value=",">逗号 , (ip,port)</option>
                        </select>
                    </div>
                    
                    <div class="config-item">
                        <label for="separator">
                            <i class="fas fa-grip-lines"></i> 条目分隔符
                        </label>
                        <select id="separator">
                            <option value=",">逗号 ,</option>
                            <option value="\n">换行符 (每行一个)</option>
                            <option value=";">分号 ;</option>
                            <option value="|">竖线 |</option>
                            <option value=" ">空格</option>
                        </select>
                    </div>
                    
                    <div class="config-item">
                        <label for="format">
                            <i class="fas fa-code"></i> 输出格式
                        </label>
                        <select id="format">
                            <option value="ip:port">ip:端口 (默认)</option>
                            <option value="ip_port">ip_端口</option>
                            <option value="ip-port">ip-端口</option>
                            <option value="完整URL">完整URL (http://ip:port)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 右侧面板：结果预览和下载 -->
            <div class="right-panel">
                <div class="panel-title">
                    <i class="fas fa-eye"></i> 提取结果预览
                </div>
                
                <div class="file-info" id="resultInfo">
                    <i class="fas fa-info-circle"></i>
                    <span>等待文件上传和提取...</span>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-download" id="downloadBtn" disabled>
                        <i class="fas fa-download"></i> 下载结果文件
                    </button>
                    <button class="btn btn-copy" id="copyBtn" disabled>
                        <i class="far fa-copy"></i> 复制到剪贴板
                    </button>
                </div>
                
                <div class="result-header">
                    <h3>提取结果</h3>
                    <div class="result-stats" id="resultStats">0 个项目</div>
                </div>
                
                <div class="preview-area">
                    <pre class="preview-content" id="previewContent">提取结果将在此处显示...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面元素引用
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const dropArea = document.getElementById('dropArea');
        const extractBtn = document.getElementById('extractBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const copyBtn = document.getElementById('copyBtn');
        const previewContent = document.getElementById('previewContent');
        const fileInfo = document.getElementById('fileInfo');
        const resultInfo = document.getElementById('resultInfo');
        const resultStats = document.getElementById('resultStats');
        const connectorSelect = document.getElementById('connector');
        const separatorSelect = document.getElementById('separator');
        const formatSelect = document.getElementById('format');
        
        // 存储提取的数据
        let extractedData = [];
        let currentFileName = '';
        
        // 事件监听器
        selectFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        extractBtn.addEventListener('click', extractData);
        downloadBtn.addEventListener('click', downloadResult);
        copyBtn.addEventListener('click', copyToClipboard);
        
        // 拖放功能
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#4b6cb7';
            dropArea.style.backgroundColor = '#f0f4ff';
        });
        
        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#b8c2cc';
            dropArea.style.backgroundColor = 'white';
        });
        
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#b8c2cc';
            dropArea.style.backgroundColor = 'white';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        // 处理文件选择
        function handleFileSelect() {
            if (!fileInput.files.length) return;
            
            const file = fileInput.files[0];
            currentFileName = file.name;
            fileInfo.textContent = `已选择文件: ${file.name} (${formatFileSize(file.size)})`;
            
            // 自动提取数据
            extractData();
        }
        
        // 提取数据
        function extractData() {
            if (!fileInput.files.length) {
                alert('请先选择一个CSV文件');
                return;
            }
            
            // 如果是通过文件输入选择的文件
            if (fileInput.files.length) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const csvData = e.target.result;
                    parseCSVData(csvData);
                };
                
                reader.readAsText(file);
            }
        }
        
        // 解析CSV数据
        function parseCSVData(csvText) {
            extractedData = [];
            
            // 分割CSV行
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                showResult([], 'CSV文件为空或格式不正确');
                return;
            }
            
            // 解析表头，尝试检测IP和端口列
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            
            // 尝试找到IP和端口列
            let ipColumn = -1;
            let portColumn = -1;
            
            // 可能的IP列名称
            const ipKeywords = ['ip', 'ip地址', '地址', 'host', '服务器'];
            // 可能的端口列名称
            const portKeywords = ['port', '端口'];
            
            // 查找IP列
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i];
                if (ipKeywords.some(keyword => header.includes(keyword))) {
                    ipColumn = i;
                    break;
                }
            }
            
            // 查找端口列
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i];
                if (portKeywords.some(keyword => header.includes(keyword))) {
                    portColumn = i;
                    break;
                }
            }
            
            // 如果未找到标准列，尝试启发式检测
            if (ipColumn === -1 || portColumn === -1) {
                // 检查第二行数据，尝试检测IP:端口格式
                if (lines.length > 1) {
                    const firstDataRow = lines[1].split(',');
                    
                    // 尝试在每个列中查找IP地址
                    for (let i = 0; i < firstDataRow.length; i++) {
                        const cell = firstDataRow[i];
                        
                        // 检测IP地址
                        if (isIPAddress(cell)) {
                            ipColumn = i;
                        }
                        
                        // 检测端口号
                        if (isPortNumber(cell)) {
                            portColumn = i;
                        }
                    }
                }
            }
            
            // 如果仍然未找到，使用默认列索引（第一列和第二列）
            if (ipColumn === -1) ipColumn = 0;
            if (portColumn === -1) portColumn = 1;
            
            // 提取数据行
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(',');
                
                // 确保有足够的列
                if (cells.length > Math.max(ipColumn, portColumn)) {
                    let ip = cells[ipColumn] ? cells[ipColumn].trim() : '';
                    let port = cells[portColumn] ? cells[portColumn].trim() : '';
                    
                    // 清理IP和端口数据
                    ip = cleanIP(ip);
                    port = cleanPort(port);
                    
                    // 验证IP和端口
                    if (isIPAddress(ip) && isPortNumber(port)) {
                        extractedData.push({ ip, port });
                    }
                }
            }
            
            // 显示结果
            showResult(extractedData, `成功从 ${lines.length-1} 行数据中提取到 ${extractedData.length} 个有效的IP和端口组合`);
        }
        
        // 显示结果
        function showResult(data, message) {
            if (data.length === 0) {
                previewContent.textContent = '未找到有效的IP和端口数据';
                resultStats.textContent = '0 个项目';
                downloadBtn.disabled = true;
                copyBtn.disabled = true;
                resultInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>${message}</span>`;
                return;
            }
            
            // 获取配置选项
            const connector = connectorSelect.value;
            const separator = separatorSelect.value === '\\n' ? '\n' : separatorSelect.value;
            const format = formatSelect.value;
            
            // 生成结果文本
            let resultText = '';
            
            data.forEach(item => {
                let itemText = '';
                
                switch(format) {
                    case '完整URL':
                        itemText = `http://${item.ip}${connector}${item.port}`;
                        break;
                    case 'ip_port':
                        itemText = `${item.ip}_${item.port}`;
                        break;
                    case 'ip-port':
                        itemText = `${item.ip}-${item.port}`;
                        break;
                    default: // ip:port
                        itemText = `${item.ip}:${item.port}`;
                }
                
                resultText += itemText + separator;
            });
            
            // 移除最后一个分隔符
            if (separator.length > 0) {
                resultText = resultText.slice(0, -separator.length);
            }
            
            // 更新UI
            previewContent.textContent = resultText;
            resultStats.textContent = `${data.length} 个项目`;
            downloadBtn.disabled = false;
            copyBtn.disabled = false;
            
            // 更新结果信息
            const formatMap = {
                ':': '冒号',
                '|': '竖线',
                '-': '连字符',
                '_': '下划线',
                ',': '逗号'
            };
            
            const separatorMap = {
                '\n': '换行符',
                ',': '逗号',
                ';': '分号',
                '|': '竖线',
                ' ': '空格'
            };
            
            const connectorText = formatMap[connector] || connector;
            const separatorText = separatorMap[separator] || separator;
            
            resultInfo.innerHTML = `<i class="fas fa-check-circle"></i><span>${message} | 格式: ${format} | 连接符: ${connectorText} | 分隔符: ${separatorText}</span>`;
        }
        
        // 下载结果
        function downloadResult() {
            if (extractedData.length === 0) return;
            
            const text = previewContent.textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // 生成文件名
            const baseName = currentFileName.replace('.csv', '') || '提取结果';
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const fileName = `${baseName}_${timestamp}.txt`;
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // 显示下载成功提示
            const originalText = resultInfo.innerHTML;
            resultInfo.innerHTML = `<i class="fas fa-check-circle"></i><span>文件已下载: ${fileName}</span>`;
            
            setTimeout(() => {
                resultInfo.innerHTML = originalText;
            }, 3000);
        }
        
        // 复制到剪贴板
        function copyToClipboard() {
            const text = previewContent.textContent;
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    // 显示复制成功提示
                    const originalText = resultInfo.innerHTML;
                    resultInfo.innerHTML = `<i class="fas fa-check-circle"></i><span>已复制 ${extractedData.length} 个项目到剪贴板</span>`;
                    
                    setTimeout(() => {
                        resultInfo.innerHTML = originalText;
                    }, 3000);
                })
                .catch(err => {
                    console.error('复制失败: ', err);
                    alert('复制到剪贴板失败，请手动选择文本复制');
                });
        }
        
        // 工具函数
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function isIPAddress(str) {
            // 简单的IP地址验证
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipRegex.test(str)) return false;
            
            // 验证每个部分在0-255之间
            const parts = str.split('.');
            for (let part of parts) {
                const num = parseInt(part, 10);
                if (num < 0 || num > 255) return false;
            }
            
            return true;
        }
        
        function isPortNumber(str) {
            const port = parseInt(str, 10);
            return !isNaN(port) && port >= 1 && port <= 65535;
        }
        
        function cleanIP(ip) {
            // 移除URL部分，只保留IP
            if (ip.includes('://')) {
                ip = ip.split('://')[1];
            }
            
            // 移除端口部分
            if (ip.includes(':')) {
                ip = ip.split(':')[0];
            }
            
            return ip.trim();
        }
        
        function cleanPort(port) {
            // 移除非数字字符
            return port.replace(/\D/g, '');
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            resultInfo.innerHTML = `<i class="fas fa-info-circle"></i><span>选择CSV文件开始提取IP和端口信息</span>`;
        });
    </script>
</body>
</html>